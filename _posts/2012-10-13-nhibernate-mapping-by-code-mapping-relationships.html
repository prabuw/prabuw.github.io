---
layout: post
title: 'NHibernate Mapping By Code : Mapping relationships'
categories:
- NHibernate
tags:
- Mapping-By-Code
- NHibernate
status: publish
type: post
published: true
meta:
  _publicize_pending: '1'
author: 
---
<p>To set the scene for the code, here is a diagram of the database.</p>
<p><a href="http://pwee167.files.wordpress.com/2012/11/database.png"><img style="background-image:none;padding-left:0;padding-right:0;display:inline;padding-top:0;border-width:0;" title="Database" border="0" alt="Database" src="http://pwee167.files.wordpress.com/2012/11/database_thumb.png" width="640" height="283"></a></p>
<p>The relationships in the above diagram are as follows:</p>
<ul>
<li>One to Many (i.e. A country has many clubs but a club belongs to only one country)</li>
<li>One to One (i.e. A club has one club detail and a club detail extends only one club)</li>
<li>Many to Many (i.e. A club has many sponsors and a sponsor works with many clubs)</li>
</ul>
<p>I have highlighted the code below that define the relationships.</p>
<div style="margin:0;display:inline;float:none;padding:0;" id="scid:C89E2BDB-ADD3-4f7a-9810-1B7EACF446C1:db762f67-e054-4f48-8b26-6bbd12e6013b" class="wlWriterEditableSmartContent">
<pre>
[sourcecode language="csharp" padlinenumbers="true" light="false" collapse="false" firstline="1" gutter="true" highlight="28,29,30,31,33,34,35,36,38,39,40,41,42,43" wraplines="false" htmlscript="false" autolink="false" toolbar="false"]
using System.Collections;
using System.Collections.Generic;
using NHibernate.Mapping.ByCode;
using NHibernate.Mapping.ByCode.Conformist;

namespace Learning.NHibernate
{
    public class Club
    {
        public virtual int Id { get; set; }
        public virtual string Name { get; set; }

        public virtual Country Country { get; set; }
        public virtual ClubDetail ClubDetail { get; set; }
        public virtual ICollection&lt;Sponsor&gt; Sponsors { get; set; }
    }
       
    public class ClubMapping : ClassMapping&lt;Club&gt;
    {
        public ClubMapping()
        {
            Schema(&quot;dbo&quot;);
            Table(&quot;Club&quot;);

            Id(i =&gt; i.Id);            
            Property(x =&gt; x.Name);

            ManyToOne(x =&gt; x.Country, x =&gt;
            {
                x.Column(&quot;CountryId&quot;);
            });

            OneToOne(x =&gt; x.ClubDetail, mapper =&gt;
            {
                mapper.PropertyReference(typeof(ClubDetail).GetProperty(&quot;Id&quot;));
            });

            Set(x =&gt; x.Sponsors, collectionMapping =&gt;
            {
                collectionMapping.Table(&quot;ClubSponsor&quot;);
                collectionMapping.Key(map =&gt; map.Column(&quot;ClubId&quot;));                  
            },
            map =&gt; map.ManyToMany(p =&gt; p.Column(&quot;SponsorId&quot;)));
        }
    }
}
[/sourcecode]
</pre>
</div>
<div style="margin:0;display:inline;float:none;padding:0;" id="scid:C89E2BDB-ADD3-4f7a-9810-1B7EACF446C1:5488cffa-de1a-4d86-9573-7652c042eb0c" class="wlWriterEditableSmartContent">
<pre>
[sourcecode language="csharp" light="false" collapse="false" autolink="false" toolbar="false" highlight="28,29,30,31,32,33,34,35,36"]
using System.Collections;
using System.Collections.Generic;
using NHibernate.Mapping.ByCode;
using NHibernate.Mapping.ByCode.Conformist;

namespace Learning.NHibernate
{
    public class Country
    {
        public virtual int Id { get; set; }
        public virtual string AbbreviatedName { get; set; }  
        public virtual string Name { get; set; }
        public virtual ICollection&lt;Club&gt; Clubs { get; set; }
    }
       
    public class CountryMapping : ClassMapping&lt;Country&gt;
    {
        public CountryMapping()
        {
            Schema(&quot;dbo&quot;);
            Table(&quot;Country&quot;);

            Id(i =&gt; i.Id);

            Property(x =&gt; x.AbbreviatedName);         
            Property(x =&gt; x.Name);

            Set(x =&gt; x.Clubs, mapping =&gt;
            {
                mapping.Key(k =&gt;
                {
                    k.Column(&quot;CountryId&quot;);
                });
                mapping.Inverse(true);                
            },
            r =&gt; r.OneToMany());
        }
    }
}

[/sourcecode]
</pre>
</div>
<div style="margin:0;display:inline;float:none;padding:0;" id="scid:C89E2BDB-ADD3-4f7a-9810-1B7EACF446C1:d508b1cf-310b-4872-9c0a-495d4d43925f" class="wlWriterEditableSmartContent">
<pre>
[sourcecode language="csharp" light="false" collapse="false" toolbar="false" autolink="false" highlight="49,50,51,52,53"]
using System.Collections;
using System.Collections.Generic;
using NHibernate.Mapping.ByCode;
using NHibernate.Mapping.ByCode.Conformist;

namespace Learning.NHibernate
{
    public class ClubDetail
    {
        public virtual int Id { get; set; }
        public virtual string AbbreviatedName { get; set; }
        public virtual string WebsiteURL { get; set; }        
        public virtual Club Club { get; set; }

        public override bool Equals(object obj)
        {
            if (ReferenceEquals(null, obj))
                return false;

            if (ReferenceEquals(this, obj))
                return true;

            var a = obj as ClubDetail;
            if (a == null)
                return false;

            return a.Club.Id == Club.Id;
        }

        public override int GetHashCode()
        {
            unchecked
            {
                var hash = 21;
                hash = hash * 37 + Club.Id.GetHashCode();

                return hash;
            }
        }
    }
       
    public class ClubDetailMapping : ClassMapping&lt;ClubDetail&gt;
    {
        public ClubDetailMapping()
        {
            Schema(&quot;dbo&quot;);
            Table(&quot;ClubDetail&quot;);

            ComposedId(i =&gt; i.ManyToOne(x =&gt; x.Club, mapper =&gt;
            {
                mapper.Column(&quot;Id&quot;);
                mapper.ForeignKey(&quot;FK_ClubDetail_Club&quot;);
            }));

            Property(x =&gt; x.Id);
            Property(x =&gt; x.AbbreviatedName);
            Property(x =&gt; x.WebsiteURL);         
        }
    }
}

[/sourcecode]
</pre>
</div>
<div style="margin:0;display:inline;float:none;padding:0;" id="scid:C89E2BDB-ADD3-4f7a-9810-1B7EACF446C1:67cfc308-320f-4378-b146-6afaeee80127" class="wlWriterEditableSmartContent">
<pre>
[sourcecode language="csharp" light="false" collapse="false" autolink="false" toolbar="false" highlight="26,27,28,29,30,31"]
using System.Collections;
using System.Collections.Generic;
using NHibernate.Mapping.ByCode;
using NHibernate.Mapping.ByCode.Conformist;

namespace Learning.NHibernate
{
    public class Sponsor
    {
        public virtual int Id { get; set; }
        public virtual string Name { get; set; }
        public virtual ICollection&lt;Club&gt; Clubs { get; set; }
    }

    public class SponsorMapping : ClassMapping&lt;Sponsor&gt;
    {
        public SponsorMapping()
        {
            Schema(&quot;dbo&quot;);
            Table(&quot;Sponsor&quot;);

            Id(i =&gt; i.Id);

            Property(x =&gt; x.Name);

            Set(x =&gt; x.Clubs, collectionMapping =&gt;
            {
                collectionMapping.Table(&quot;ClubSponsor&quot;);
                collectionMapping.Key(map =&gt; map.Column(&quot;SponsorId&quot;));
            },
            map =&gt; map.ManyToMany(p =&gt; p.Column(&quot;ClubId&quot;)));
        }
    }
}

[/sourcecode]
</pre>
</div>
