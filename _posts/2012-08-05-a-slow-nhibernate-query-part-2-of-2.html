---
layout: post
title: A slow NHibernate query (PART 2 of 2)
categories:
- NHibernate
tags:
- Mapping-By-Code
- NHibernate
- Performance
status: publish
type: post
published: true
meta: {}
author: 
---
<p align="justify">Following on from the <a href="http://pwee167.wordpress.com/2012/08/03/a-slow-nhibernate-query-part-1-of-2/">original post</a>, I started using NHibernate’s mapping-by-code to map a database table to my POCO. Some background to the problem:</p>
<ul>
<li>
<div align="justify">The type of database is Oracle 10g. </div>
<li>
<div align="justify">It’s not hosted on my local machine (i.e. some server away from me). </div>
<li>
<div align="justify">I am using the latest version NHibernate (3.3.1.4) from NuGet.</div>
</li>
</ul>
<p align="justify">Here is the mapping code:</p>
<p align="justify">
<div align="justify">
<div style="margin:0;display:inline;float:none;padding:0;" id="scid:C89E2BDB-ADD3-4f7a-9810-1B7EACF446C1:e8112dd0-3675-4798-bbde-1e0aef4c73a1" class="wlWriterEditableSmartContent">
<pre>
[sourcecode language="csharp"]
using NHibernate.Mapping.ByCode.Conformist;

namespace Learning.NHibernate
{
    public class Person
    {
        public virtual string PersonId { get; set; }
        public virtual string FirstName { get; set; }
        public virtual string LastName { get; set; }
    }

    public class PersonMap : ClassMapping&lt;Person&gt;
    {
        public PersonMap()
        {
            Schema(&quot;MyDB&quot;);
            Table(&quot;Person&quot;);
            Id(i =&gt; i.PersonId);
            Property(i =&gt; i.FirstName);
            Property(i =&gt; i.LastName);
        }
    }
}

[/sourcecode]
</pre>
</div>
</div>
<p align="justify">
<p align="justify">Here is the code used to connect to the build the session factory, open the session and execute the query:</p>
<p align="justify">
<div align="justify">
<div style="margin:0;display:inline;float:none;padding:0;" id="scid:C89E2BDB-ADD3-4f7a-9810-1B7EACF446C1:bc45f904-783d-4c77-879d-7ae975660fb7" class="wlWriterEditableSmartContent">
<pre>
[sourcecode language="csharp"]
using System;
using System.Diagnostics;
using System.Reflection;
using NHibernate.Cfg;
using NHibernate.Dialect;
using NHibernate.Driver;
using NHibernate.Mapping.ByCode;

namespace Learning.NHibernate
{
    class Program
    {
        static void Main(string[] args)
        {
            var stopwatch = new Stopwatch();

            var mapper = new ModelMapper();
            var cfg = new Configuration();

            mapper.AddMappings(Assembly.GetExecutingAssembly().GetExportedTypes());

            cfg.DataBaseIntegration(c =&gt;
            {
                c.ConnectionString = @&quot;User Id=user;Password=password;Data Source=MyDB;&quot;;
                c.Driver&lt;OracleClientDriver&gt;();
                c.Dialect&lt;Oracle10gDialect&gt;();

                c.LogSqlInConsole = true;
                c.LogFormattedSql = true;
                c.AutoCommentSql = true;
            });

            cfg.AddMapping(mapper.CompileMappingForAllExplicitlyAddedEntities());
            var sessionFactory = cfg.BuildSessionFactory();

            stopwatch.Stop();
            Console.WriteLine(&quot;Setting up: {0}&quot;, stopwatch.ElapsedMilliseconds);
            stopwatch.Restart();

            Person entity = null;

            using (var session = sessionFactory.OpenSession())
            using (var tx = session.BeginTransaction())
            {
                stopwatch.Stop();
                Console.WriteLine(&quot;Opening session: {0}&quot;, stopwatch.ElapsedMilliseconds);
                stopwatch.Restart();

                entity = session.Get&lt;Person&gt;(&quot;1&quot;);

                stopwatch.Stop();
                Console.WriteLine(&quot;Retrieving data: {0}&quot;, stopwatch.ElapsedMilliseconds);
                stopwatch.Restart();

                tx.Commit();
            }

            stopwatch.Stop();
            Console.WriteLine(&quot;Finish: {0}&quot;, stopwatch.ElapsedMilliseconds);           
        }
    }
}

[/sourcecode]
</pre>
</div>
</div>
<p align="justify">
<p align="justify">Pretty straight forward&nbsp; stuff here. Even with the overhead of an ORM, this should be very fast. It’s taking roughly <u>80-100 seconds</u> to get accessed to the retrieved object! </p>
<p align="justify"><strong><u>Debugging the problem</u></strong></p>
<p align="justify">So I begin to investigate the situation, first up the generated query:</p>
<div align="justify">
<div style="margin:0;display:inline;float:none;padding:0;" id="scid:C89E2BDB-ADD3-4f7a-9810-1B7EACF446C1:ff68e7e4-d45d-468e-bab6-5dd5fd605192" class="wlWriterEditableSmartContent">
<pre>
[sourcecode language="sql"]
SELECT person0_.PersonId as PersonId0_0_, 
person0_.FirstName as FirstName0_0_, person0_.LastName as LastName0_0_,  
FROM MyDB.Person person0_
WHERE person0_.PersonId=:p0;
:p0 = '1' 
[/sourcecode]
</pre>
</div>
</div>
<p align="justify">This looked normal to me. So the checklist goes as follows:</p>
<ul>
<li>
<div align="justify">The <em>PersonId</em> column is indexed, in fact it is the primary key. </div>
<li>
<div align="justify">I ran the query via PL/SQL Developer and it took around 32ms. </div>
<li>
<div align="justify">The query plan on the query confirmed the use of a index unique scan and not a dreaded full table scan.</div>
<li>
<div align="justify">I ran the un-parameterized query via ADO.Net and it took roughly 180ms.</div>
<li>
<div align="justify">I got <a title="NHibernate Profiler" href="http://nhprof.com/">NHProf</a> (trial version) to profile my code and got the following:</div>
</li>
</ul>
<p align="justify"><a href="http://pwee167.files.wordpress.com/2012/08/n2fpe1.png"><img style="background-image:none;padding-left:0;padding-right:0;display:inline;padding-top:0;border-width:0;" title="N2fpe" border="0" alt="N2fpe" src="http://pwee167.files.wordpress.com/2012/08/n2fpe_thumb1.png" width="286" height="86"></a></p>
<p align="justify">It felt like the query gets executed and the results are returned, but something else was taking up the time. Finally, I decided it was time to get the <a href="https://github.com/nhibernate/nhibernate-core">source to NHibernate</a> and step through it. </p>
<p align="justify">The execution inside NHibernate is moving along nicely until it hits this line:</p>
<div style="margin:0;display:inline;float:none;padding:0;" id="scid:C89E2BDB-ADD3-4f7a-9810-1B7EACF446C1:35c19a8a-1e34-46c3-9f64-2fe89735cb24" class="wlWriterEditableSmartContent">
<pre>
[sourcecode language="csharp"]
for (count = 0; count &lt; maxRows &amp;&amp; rs.Read(); count++)   
[/sourcecode]
</pre>
</div>
<p align="justify">Specifically, the code that holds up the execution is <em>rs.Read()</em>, the oracle datareader. Why? Still stuck, I struck some luck and found someone with the same problem, and who blogged about it <a href="http://www.gitshah.com/2009/10/issue-with-systemdataoracleclient-and.html">here</a>.</p>
<p align="justify"><strong><u>What’s the issue?</u></strong></p>
<p align="justify">Nhibernate uses ADO.Net’s <a href="http://msdn.microsoft.com/en-us/library/yy6y35y8.aspx">parameterised queries</a>.&nbsp; The data type of a parameter is specific to the data provider, in my case: <em>System.Data.OracleClient</em>. </p>
<p align="justify">The issue lies with the database type associated with the parameter in the parameterised query.&nbsp; </p>
<ul>
<li>
<div align="justify">I have defined the <em>PersonId</em> column in the NHibernate mapping as a .NET Type of <em>String</em>.</div>
</li>
<li>
<div align="justify">NHibernate determines (via reflection in the case of mapping-by-code) the <em><a href="http://msdn.microsoft.com/en-us/library/system.data.dbtype.aspx">DbType</a></em> of <em>PersonId</em> to be of <em>String</em>, a type representing Unicode characters. </div>
</li>
<li>
<div align="justify">This translates to a database type of <em>NVarchar or Char</em>. </div>
</li>
<li>
<div align="justify">However, <em>PersonId</em> is of type <em>Varchar2</em>, which is based on the ANSI standard. </div>
</li>
</ul>
<p align="justify">I believe this mismatch results in a full table scan, rather than an index scan. This probably is not as noticeable on a smaller sized table, but when the size of the table is larger (~3 millions records), the performance deteriorates significantly.</p>
<p align="justify"><strong><u>Solution</u></strong></p>
<p align="justify">Firstly, I updated to <a href="http://www.oracle.com/technetwork/topics/dotnet/index-085163.html">Oracle’s .NET data provider</a>, including installing <a href="http://www.oracle.com/technetwork/developer-tools/visual-studio/downloads/index.html">ODAC</a> (Oracle Data Access Components). While this had no bearing on resolving the issue, it is recommended to do so as <em><a href="http://msdn.microsoft.com/en-us/library/system.data.oracleclient.aspx">System.Data.OracleClient</a></em> has been deprecated.</p>
<p align="justify">The solution that finally resolved the problem was to explicitly set the type of the property to <em><u>Ansistring</u></em>, as seen in the code below.</p>
<div style="margin:0;display:inline;float:none;padding:0;" id="scid:C89E2BDB-ADD3-4f7a-9810-1B7EACF446C1:477f65e0-b75a-454b-bab9-17bd35b09e66" class="wlWriterEditableSmartContent">
<pre>
[sourcecode language="csharp" padlinenumbers="true"]
using NHibernate;
using NHibernate.Mapping.ByCode.Conformist;

namespace Learning.NHibernate
{
    public class PersonMapping : ClassMapping&lt;Person&gt;
    {
        public PersonMapping()
        {
            Schema(&quot;dbo&quot;);
            Table(&quot;Person&quot;);
            Property(x =&gt; x.Id, m =&gt; m.Type(NHibernateUtil.AnsiString));
            Property(x =&gt; x.FirstName);
            Property(x =&gt; x.LastName);
        }
    }
}
[/sourcecode]
</pre>
</div>
<p align="justify">In conclusion, if your database contains non-Unicode columns and you are using NHibernate as your ORM of choice, remember to specify the type as <em>Ansistring</em> in the NHibernate mapping.</p>
<p align="justify">
